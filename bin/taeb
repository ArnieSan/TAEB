#!/usr/bin/env perl
use strict;
use warnings;
use lib 'lib';
use TAEB;
use Curses;

$SIG{__WARN__} = sub {
    my $method = $_[0] =~ /^Use of uninitialized / ? 'undef' : 'perl';
    TAEB->log->$method($_[0], level => 'warning');
};

$SIG{__DIE__} = sub {
    TAEB->save_state;

    unless ("@_" =~ /Game over, man|See you soon|Until we meet again/) {
        TAEB->log->perl($_[0], level => 'error');
        if (TAEB->config->unattended) {
            TAEB->quit;
            TAEB->died;
        } else {
            TAEB->save;
        }
        endwin;
    }

    endwin;
    die @_;
};

my $tstp = $SIG{TSTP} = sub {
    # if we don't invoke TSTP then we won't be suspended
    $SIG{TSTP} = 'DEFAULT';

    def_prog_mode();
    endwin();

    kill TSTP => $$;
};

$SIG{CONT} = sub {
    $SIG{TSTP} = $tstp;

    TAEB->redraw(force_clear => 1);
};

$TAEB::ToScreen = 1;
$| = 1;

initscr;
END { endwin }
noecho;
cbreak;
start_color;
use_default_colors;
init_pair($_, $_, 0) for 0 .. 7;

$SIG{INT} = sub { TAEB->save };

addstr "Loading TAEB...";

TAEB->play;

