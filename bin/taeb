#!/usr/bin/env perl
use strict;
use warnings;
use lib 'lib';
use TAEB;
use Curses;
use List::Util qw/max/;

TAEB->setup_handlers;

my $loop = grep { $_ eq '--loop' } @ARGV;

my $tstp = $SIG{TSTP} = sub {
    # if we don't invoke TSTP then we won't be suspended
    $SIG{TSTP} = 'DEFAULT';

    def_prog_mode();
    endwin();

    kill TSTP => $$;
};

$SIG{CONT} = sub {
    $SIG{TSTP} = $tstp;

    TAEB->redraw(force_clear => 1);
};

$TAEB::ToScreen = 1;
$| = 1;

initscr;
END { endwin }
noecho;
cbreak;
start_color;
use_default_colors;
init_pair($_, $_, 0) for 0 .. 7;

while (1) {
    clear;
    refresh;

    addstr "Loading TAEB...";

    eval {
        local $SIG{INT} = sub { TAEB->save; $loop = 0 };
        TAEB->play;
    };

    last unless $loop;
    endwin;

    TAEB->reset_state;

    print ' ';
    for (reverse 1..5) {
        print "\x08$_";
        sleep 1;
    }
}
